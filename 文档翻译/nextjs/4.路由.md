# Routing Fundamentals

每个应用程序的骨架是路由。

This page will introduce you to the **fundamental concepts** of routing for the web and how to handle routing in Next.js.

## [Terminology](https://nextjs.org/docs/app/building-your-application/routing#terminology)(术语)

First, you will see these terms being used throughout the documentation.

Here's a quick reference:

<img src="image/imageurl=%252Fdocs%252Flight%252Fterminology-component-tree.png" alt="Terminology for Component Tree" style="zoom: 50%;" />

- **Tree:** 一种用于可视化层次结构的约定。 For example, a component tree with parent and children components, a folder structure, etc.
- **Subtree:** Part of a tree, starting at a new root (first) and ending at the leaves (last).
- **Root**: The first node in a tree or subtree, such as a root layout.
- **Leaf:** Nodes in a subtree that have no children, such as the last segment in a URL path.

![Terminology for URL Anatomy](image/imageurl=%252Fdocs%252Flight%252Fterminology-url-anatomy.png)

- **URL Segment:** Part of the URL path delimited by slashes.(由斜杠分隔的URL路径的一部分。)
- **URL Path:** Part of the URL that comes after the domain (composed(组成) of segments).

---

## [The `app` Router](https://nextjs.org/docs/app/building-your-application/routing#the-app-router)

In version 13, Next.js introduced a new **App Router** built on [React Server Components](https://nextjs.org/docs/app/building-your-application/rendering/server-components), which supports shared layouts, nested routing, loading states, error handling, and more.

The App Router works in a new directory named `app`.

应用程序目录与页面目录一起工作，以实现渐进式采用。

This allows you to opt some routes of your application into the new behavior while keeping other routes in the `pages` directory for previous behavior. 

If your application uses the `pages` directory, please also see the [Pages Router](https://nextjs.org/docs/pages/building-your-application/routing) documentation.

>**Good to know**: The App Router takes priority over the Pages Router. Routes across directories(跨目录) should not resolve to the same URL path and will cause a build-time error to prevent a conflict.

**By default**, components inside `app` are [React Server Components](https://nextjs.org/docs/app/building-your-application/rendering/server-components). 

This is a performance optimization and allows you to easily adopt them, and you can also use [Client Components](https://nextjs.org/docs/app/building-your-application/rendering/client-components).

>**Recommendation:** Check out(查看) the [Server](https://nextjs.org/docs/app/building-your-application/rendering/server-components) page if you're new(新手) to Server Components.

## [Roles of Folders and Files](https://nextjs.org/docs/app/building-your-application/routing#roles-of-folders-and-files)

Next.js uses a file-system based router where:

- **Folders** are used to define routes. A route is a single path of nested folders, following the file-system hierarchy(层次结构) from the **root folder** down to a final **leaf folder** that includes a `page.js` file. See [Defining Routes](https://nextjs.org/docs/app/building-your-application/routing/defining-routes).
- **Files** are used to create UI that is shown for a route segment. See [special files](https://nextjs.org/docs/app/building-your-application/routing#file-conventions).

---

## [Route Segments](https://nextjs.org/docs/app/building-your-application/routing#route-segments)

Each folder in a route represents a **route segment**. 

Each route segment is mapped to a corresponding **segment** in a **URL path**.

<img src="image/imageurl=%252Fdocs%252Flight%252Froute-segments-to-path-segments.png" alt="How Route Segments Map to URL Segments" style="zoom:50%;" />

---

## [Nested Routes](https://nextjs.org/docs/app/building-your-application/routing#nested-routes)

To create a nested route, you can nest folders inside each other. 

For example, you can add a new `/dashboard/settings` route by nesting two new folders in the `app` directory.

The `/dashboard/settings` route is composed of three segments:

- `/` (Root segment)
- `dashboard` (Segment)
- `settings` (Leaf segment)

## [File Conventions](https://nextjs.org/docs/app/building-your-application/routing#file-conventions)

Next.js provides a set of special files to create UI with specific behavior in nested routes:

| [`layout`](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts#layouts) | Shared UI for a segment and its children                     |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| [`page`](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts#pages) | Unique UI of a route and make routes publicly accessible     |
| [`loading`](https://nextjs.org/docs/app/building-your-application/routing/loading-ui-and-streaming) | Loading UI for a segment and its children                    |
| [`not-found`](https://nextjs.org/docs/app/api-reference/file-conventions/not-found) | Not found UI for a segment and its children                  |
| [`error`](https://nextjs.org/docs/app/building-your-application/routing/error-handling) | Error UI for a segment and its children                      |
| [`global-error`](https://nextjs.org/docs/app/building-your-application/routing/error-handling) | Global Error UI                                              |
| [`route`](https://nextjs.org/docs/app/building-your-application/routing/route-handlers) | Server-side API endpoint                                     |
| [`template`](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts#templates) | Specialized re-rendered Layout UI                            |
| [`default`](https://nextjs.org/docs/app/api-reference/file-conventions/default) | Fallback UI for [Parallel Routes](https://nextjs.org/docs/app/building-your-application/routing/parallel-routes) |

>**Good to know**: `.js`, `.jsx`, or `.tsx` file extensions(扩展?后缀?) can be used for special files.

## [Component Hierarchy](https://nextjs.org/docs/app/building-your-application/routing#component-hierarchy)

The React components defined in special files of a route segment are rendered in a specific hierarchy:

- `layout.js`
- `template.js`
- `error.js` (React error boundary)
- `loading.js` (React suspense boundary)
- `not-found.js` (React error boundary)
- `page.js` or nested `layout.js`

<img src="image/imageurl=%252Fdocs%252Flight%252Ffile-conventions-component-hierarchy.png" alt="Component Hierarchy for File Conventions" style="zoom:50%;" />

In a nested route, the components of a segment will be nested **inside** the components of its parent segment.

<img src="image/imageurl=%252Fdocs%252Flight%252Fnested-file-conventions-component-hierarchy.png" alt="Nested File Conventions Component Hierarchy" style="zoom:50%;" />

---

## [Colocation](https://nextjs.org/docs/app/building-your-application/routing#colocation)

In addition to special files, you have the option to colocate(放置?) your own files (e.g. components, styles, tests, etc) inside folders in the `app` directory.

This is because while folders define routes, only the contents returned by `page.js` or `route.js` are publicly addressable(公开访问).

<img src="image/imageurl=%252Fdocs%252Flight%252Fproject-organization-colocation.png" alt="An example folder structure with colocated files" style="zoom:50%;" />

Learn more about [Project Organization and Colocation](https://nextjs.org/docs/app/building-your-application/routing/colocation).

---

## [Advanced Routing Patterns](https://nextjs.org/docs/app/building-your-application/routing#advanced-routing-patterns)

The App Router also provides a set of conventions to help you implement(实现) more advanced routing patterns. These include:

- [Parallel Routes](https://nextjs.org/docs/app/building-your-application/routing/parallel-routes): 允许您同时在同一视图中显示两个或更多页面，并可以独立导航。 You can use them for split views that have their own sub-navigation. E.g. Dashboards.
- [Intercepting Routes](https://nextjs.org/docs/app/building-your-application/routing/intercepting-routes)(拦截路由): Allow you to intercept a route and show it in the context of another route. You can use these when keeping the context for the current page is important. E.g. Seeing all tasks while editing one task or expanding a photo in a feed(在动态中展开一张照片).

这些模式使您能够构建更丰富和复杂的用户界面，使过去对小团队和个人开发者来说历史上复杂的功能变得民主化。

# Defining Routes

>We recommend reading the [Routing Fundamentals](https://nextjs.org/docs/app/building-your-application/routing) page before continuing.

This page will guide you through how to define and organize routes in your Next.js application.

---

## [Creating Routes](https://nextjs.org/docs/app/building-your-application/routing/defining-routes#creating-routes)

Next.js uses a file-system based router where **folders** are used to define routes.

Each folder represents a [**route** segment](https://nextjs.org/docs/app/building-your-application/routing#route-segments) that maps to a **URL** segment. To create a [nested route](https://nextjs.org/docs/app/building-your-application/routing#nested-routes), you can nest folders inside each other.

A special [`page.js` file](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts#pages) is used to make route segments publicly accessible.

<img src="image/imageurl=%252Fdocs%252Flight%252Fdefining-routes.png" alt="Defining Routes" style="zoom:50%;" />

In this example, the `/dashboard/analytics` URL path is *not* publicly accessible because it does not have a corresponding(对应的) `page.js` file. 

This folder could be used to store components, stylesheets, images, or other colocated files.

>**Good to know**: `.js`, `.jsx`, or `.tsx` file extensions can be used for special files.

---

## [Creating UI](https://nextjs.org/docs/app/building-your-application/routing/defining-routes#creating-ui)

[Special file conventions](https://nextjs.org/docs/app/building-your-application/routing#file-conventions) are used to create UI for each route segment.

The most common are [pages](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts#pages) to show UI unique to a route, and [layouts](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts#layouts) to show UI that is shared across multiple routes.

For example, to create your first page, add a `page.js` file inside the `app` directory and export a React component:

```tsx
export default function Page() {
  return <h1>Hello, Next.js!</h1>
}
```

# Pages and Layouts

>We recommend reading the [Routing Fundamentals](https://nextjs.org/docs/app/building-your-application/routing) and [Defining Routes](https://nextjs.org/docs/app/building-your-application/routing/defining-routes) pages before continuing.

The App Router inside Next.js 13 introduced new file conventions to easily create [pages](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts#pages), [shared layouts](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts#layouts), and [templates](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts#templates). 

This page will guide you through how to use these special files in your Next.js application.

---

## [Pages](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts#pages)

A page is UI that is **unique** to a route.(页面是与路由相关的独特用户界面。)

You can define pages by exporting(导出) a component from a `page.js` file.

Use nested folders to [define a route](https://nextjs.org/docs/app/building-your-application/routing/defining-routes) and a `page.js` file to make the route publicly accessible.

```tsx
// `app/page.tsx` is the UI for the `/` URL
export default function Page() {
  return <h1>Hello, Home page!</h1>
}
```

```tsx
// `app/dashboard/page.tsx` is the UI for the `/dashboard` URL
export default function Page() {
  return <h1>Hello, Dashboard Page!</h1>
}
```

>**Good to know**:
>
>- A page is always the [leaf](https://nextjs.org/docs/app/building-your-application/routing#terminology) of the [route subtree](https://nextjs.org/docs/app/building-your-application/routing#terminology).
>- `.js`, `.jsx`, or `.tsx` file extensions can be used for Pages.
>- A `page.js` file is required to make a route segment publicly accessible.
>- Pages are [Server Components](https://nextjs.org/docs/app/building-your-application/rendering/server-components) by default but can be set to a [Client Component](https://nextjs.org/docs/app/building-your-application/rendering/client-components).
>- Pages can fetch data. View the [Data Fetching](https://nextjs.org/docs/app/building-your-application/data-fetching) section for more information.

---

## [Layouts](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts#layouts)

A layout is UI that is **shared** between multiple pages.

在导航中，布局保持状态、保持交互，并且不重新渲染。

Layouts can also be [nested](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts#nesting-layouts).

You can define a layout by `default` exporting a React component from a `layout.js` file.

该组件应接受一个 children 属性，在渲染过程中将填充为子布局（如果存在）或子页面。

```tsx
export default function DashboardLayout({
  children, // will be a page or nested layout
}: {
  children: React.ReactNode
}) {
  return (
    <section>
      {/* Include shared UI here e.g. a header or sidebar */}
      <nav></nav>
 
      {children}
    </section>
  )
}
```

>**Good to know**:
>
>- The top-most layout is called the [Root Layout](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts#root-layout-required). This **required** layout is shared across all pages in an application. Root layouts must contain `html` and `body` tags.
>- Any route segment can optionally define its own [Layout](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts#nesting-layouts). These layouts will be shared across all pages in that segment.
>- 默认情况下，路由中的布局是嵌套的。Each parent layout wraps child layouts below it using the React `children` prop.
>- You can use [Route Groups](https://nextjs.org/docs/app/building-your-application/routing/route-groups) to opt specific route segments in and out(进入和退出) of shared layouts.
>- Layouts are [Server Components](https://nextjs.org/docs/app/building-your-application/rendering/server-components) by default but can be set to a [Client Component](https://nextjs.org/docs/app/building-your-application/rendering/client-components).
>- Layouts can fetch data. View the [Data Fetching](https://nextjs.org/docs/app/building-your-application/data-fetching) section for more information.
>- Passing data(传递数据) between a parent layout and its children is not possible. 然而，您可以多次在路由中获取相同的数据，React会自动去重请求，**不会影响性能**。
>- 布局本身无法访问其下方的路由片段。**To access all route segments, you can use [`useSelectedLayoutSegment`](https://nextjs.org/docs/app/api-reference/functions/use-selected-layout-segment) or [`useSelectedLayoutSegments`](https://nextjs.org/docs/app/api-reference/functions/use-selected-layout-segments) in a Client Component.**
>- `.js`, `.jsx`, or `.tsx` file extensions can be used for Layouts.
>- A `layout.js` and `page.js` file can be defined in the same folder. The layout will wrap the page.

### [Root Layout (Required)](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts#root-layout-required)

The root layout is defined at the top level of the `app` directory and applies to all routes. 

此布局使您能够修改从服务器返回的初始HTML。

```tsx
export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body>{children}</body>
    </html>
  )
}
```

>**Good to know**:
>
>- The `app` directory **must** include a root layout.
>- The root layout must define `<html>` and `<body>` tags since Next.js does not automatically create them.
>- You can use the [built-in SEO support](https://nextjs.org/docs/app/building-your-application/optimizing/metadata) to manage `<head>` HTML elements, for example, the `<title>` element.
>- You can use [route groups](https://nextjs.org/docs/app/building-your-application/routing/route-groups) to create multiple root layouts. See an [example here](https://nextjs.org/docs/app/building-your-application/routing/route-groups#creating-multiple-root-layouts).
>- The root layout is a [Server Component](https://nextjs.org/docs/app/building-your-application/rendering/server-components) by default and **can not be set to a [Client Component](https://nextjs.org/docs/app/building-your-application/rendering/client-components).**



>**Migrating(迁移) from the `pages` directory:** The root layout replaces the [`_app.js`](https://nextjs.org/docs/pages/building-your-application/routing/custom-app) and [`_document.js`](https://nextjs.org/docs/pages/building-your-application/routing/custom-document) files. [View the migration guide](https://nextjs.org/docs/app/building-your-application/upgrading/app-router-migration#migrating-_documentjs-and-_appjs).

### [Nesting Layouts](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts#nesting-layouts)

Layouts defined inside a folder (e.g. `app/dashboard/layout.js`) apply to specific route segments (e.g. `acme.com/dashboard`) and render when those segments are active.

By default, layouts in the file hierarchy are **nested**, which means they wrap child layouts via their `children` prop.

<img src="image/imageurl=%252Fdocs%252Flight%252Fnested-layout.png" alt="Nested Layout" style="zoom:50%;" />

```tsx
//app/dashboard/layout.tsx
export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return <section>{children}</section>
}
```

>**Good to know**:
>
>- Only the root layout can contain `<html>` and `<body>` tags.

如果将上述两个布局结合起来，根布局（app/layout.js）会包裹仪表板布局（app/dashboard/layout.js），而仪表板布局又会包裹在 app/dashboard/* 中的路由片段中。

The two layouts would be nested as such:

<img src="image/imageurl=%252Fdocs%252Flight%252Fnested-layouts-ui.png" alt="Nested Layouts" style="zoom:50%;" />

You can use [Route Groups](https://nextjs.org/docs/app/building-your-application/routing/route-groups) to opt specific route segments in and out of shared layouts.

---

## [Templates](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts#templates)

Templates are similar to layouts in that they wrap each child layout or page. 

与在路由之间保持状态的布局不同，模板在导航时为每个子项创建一个新实例。

这意味着当用户在共享模板的路由之间导航时，组件的新实例被挂载，DOM元素被重新创建，状态不会保留，并且效果将重新同步。

在某些情况下，您可能需要这些特定的行为，而模板比布局更适合。

For example:

- 依赖于useEffect的功能（例如记录页面浏览量）和useState的功能（例如每个页面的反馈表单）。
- To change the default framework behavior. 例如，布局内的(Suspense Boundaries)悬念边界只在加载布局时首次显示回退内容，而在切换页面时不会显示。For templates, the fallback is shown on each navigation.

A template can be defined by exporting a default React component from a `template.js` file. 

The component should accept a `children` prop.

```tsx
export default function Template({ children }: { children: React.ReactNode }) {
  return <div>{children}</div>
}
```

In terms of nesting, `template.js` is rendered **between a layout and its children**. Here's a simplified output:

```tsx
<Layout>
  {/* Note that the template is given a unique key. */}
  <Template key={routeParam}>{children}</Template>
</Layout>
```

---

## [Modifying`<head>`](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts#modifying-head)

In the `app` directory, you can modify the `<head>` HTML elements such as `title` and `meta` using the [built-in SEO support](https://nextjs.org/docs/app/building-your-application/optimizing/metadata).

Metadata can be defined by exporting a [`metadata` object](https://nextjs.org/docs/app/api-reference/functions/generate-metadata#the-metadata-object) or [`generateMetadata` function](https://nextjs.org/docs/app/api-reference/functions/generate-metadata#generatemetadata-function) in a [`layout.js`](https://nextjs.org/docs/app/api-reference/file-conventions/layout) or [`page.js`](https://nextjs.org/docs/app/api-reference/file-conventions/page) file.

```tsx
// app/page.tsx
import { Metadata } from 'next'
 
export const metadata: Metadata = {
  title: 'Next.js',
}
 
export default function Page() {
  return '...'
}
```

> **Good to know**:
>
> You should **not** manually(手动的) add `<head>` tags such as `<title>` and `<meta>` to root layouts.
>
> 相反，您应该使用[Metadata ](https://nextjs.org/docs/app/api-reference/functions/generate-metadata) API，它会自动处理高级需求，如流式传输和去重`<head>`元素。

[Learn more about available metadata options in the API reference.](https://nextjs.org/docs/app/api-reference/functions/generate-metadata)

# Linking and Navigating

There are two ways to navigate between routes in Next.js:

- Using the [`Link` Component](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#link-component)
- Using the [`useRouter` Hook](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#userouter-hook)

This page will go through(介绍) how to use `<Link>`, `useRouter()`, and dive deeper into how navigation works.

---

## [`Link` Component](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#link-component)

`<Link>` is a built-in component that extends the HTML `<a>` tag to provide [prefetching](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#1-prefetching) and client-side navigation between routes. 

 It is the primary way to navigate between routes in Next.js.

You can use it by importing it from `next/link`, and passing a `href` prop to the component:

```tsx
import Link from 'next/link'
 
export default function Page() {
  return <Link href="/dashboard">Dashboard</Link>
}
```

There are other optional props you can pass to `<Link>`. See the [API reference](https://nextjs.org/docs/app/api-reference/components/link) for more.

### [Examples](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#examples)

#### [Linking to Dynamic Segments](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#linking-to-dynamic-segments)

When linking to [dynamic segments](https://nextjs.org/docs/app/building-your-application/routing/dynamic-routes), you can use [template literals and interpolation](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Template_literals)(模板字面量和插值) to generate a list of links.

```tsx
import Link from 'next/link'
 
export default function PostList({ posts }) {
  return (
    <ul>
      {posts.map((post) => (
        <li key={post.id}>
          <Link href={`/blog/${post.slug}`}>{post.title}</Link>
        </li>
      ))}
    </ul>
  )
}
```

#### [Checking Active Links](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#checking-active-links)

You can use [`usePathname()`](https://nextjs.org/docs/app/api-reference/functions/use-pathname) to determine if a link is active.

For example, to add a class to the active link, you can check if the current `pathname` matches the `href` of the link:

```tsx
'use client'
 
import { usePathname } from 'next/navigation'
import Link from 'next/link'
 
export function Links() {
  const pathname = usePathname()
 
  return (
    <nav>
      <ul>
        <li>
          <Link className={`link ${pathname === '/' ? 'active' : ''}`} href="/">
            Home
          </Link>
        </li>
        <li>
          <Link
            className={`link ${pathname === '/about' ? 'active' : ''}`}
            href="/about"
          >
            About
          </Link>
        </li>
      </ul>
    </nav>
  )
}
```

#### [Scrolling to an `id`](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#scrolling-to-an-id)

The default behavior of the Next.js App Router is to scroll to the top of a new route or to maintain the scroll position for backwards and forwards navigation.

If you'd like to scroll to a specific `id` on navigation, you can append your URL with a `#` hash link or just pass a hash link to the `href` prop.

This is possible since `<Link>` renders to an `<a>` element.

```tsx
<Link href="/dashboard#settings">Settings</Link>
 
// Output
<a href="/dashboard#settings">Settings</a>
```

#### [Disabling scroll restoration](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#disabling-scroll-restoration)(禁用滚动恢复)

The default behavior of the Next.js App Router is to scroll to the top of a new route or to maintain the scroll position for backwards and forwards navigation.

If you'd like to disable this behavior, you can pass `scroll={false}` to the `<Link>` component, or `scroll: false` to `router.push()` or `router.replace()`.

```tsx
// next/link
<Link href="/dashboard" scroll={false}>
  Dashboard
</Link>
```

```tsx
// useRouter
import { useRouter } from 'next/navigation'
 
const router = useRouter()
 
router.push('/dashboard', { scroll: false })
```

---

The `useRouter` hook allows you to programmatically(编程式地) change routes.

This hook can only be used inside Client Components and is imported from `next/navigation`.

```tsx
'use client'
 
import { useRouter } from 'next/navigation'
 
export default function Page() {
  const router = useRouter()
 
  return (
    <button type="button" onClick={() => router.push('/dashboard')}>
      Dashboard
    </button>
  )
}
```

有关useRouter方法的完整列表，请参阅[API reference](https://nextjs.org/docs/app/api-reference/functions/use-router).

> **Recommendation:** Use the `<Link>` component to navigate between routes unless you have a specific requirement for using `useRouter`.

---

## [How Routing and Navigation Works](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#how-routing-and-navigation-works)

The App Router uses a hybrid approach for routing and navigation. 

On the server, your application code is automatically code-split(代码拆分) by route segments.

 And on the client, Next.js [prefetches](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#1-prefetching) and [caches](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#2-caching) the route segments.

This means, when a user navigates to a new route, the browser doesn't reload the page, and only the route segments that change re-render - improving the navigation experience and performance.

### [1. Prefetching](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#1-prefetching)

Prefetching is a way to preload a route in the background before the user visits it.

There are two ways routes are prefetched in Next.js:

- **`<Link>` component**: Routes are automatically prefetched as they become visible in the user's viewport. 

Prefetching happens when the page **first loads** or when it comes into **view through scrolling**.

- **`router.prefetch()`**: The `useRouter` hook can be used to prefetch routes programmatically.

The`<Link>`'s prefetching behavior is different for static and dynamic routes:

- [**Static Routes**](https://nextjs.org/docs/app/building-your-application/rendering/server-components#static-rendering-default): `prefetch` defaults to `true`. The entire route is prefetched and cached.
- [**Dynamic Routes**](https://nextjs.org/docs/app/building-your-application/rendering/server-components#dynamic-rendering): `prefetch` default to automatic.

Only the shared layout down until the first `loading.js` file is prefetched and cached for `30s`.

这样可以降低获取整个动态路由的成本，并且意味着您可以显示即时加载状态，以便更好地向用户提供视觉反馈。

You can disable prefetching by setting the `prefetch` prop to `false`.

See the [`Link` API reference](https://nextjs.org/docs/app/api-reference/components/link) for more information.

>**Good to know**:
>
>- Prefetching is not enabled in development, **only in production.**

### [2. Caching](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#2-caching)

Next.js has an **in-memory(内存) client-side cache** called the [Router Cache](https://nextjs.org/docs/app/building-your-application/data-fetching/fetching-caching-and-revalidating#caching-data#router-cache).

As users navigate around the app, the React Server Component Payload of [prefetched](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#1-prefetching) route segments and visited routes are stored in the cache.

This means on navigation, the cache is reused as much as possible, instead of making a new request to the server - improving performance by reducing the number of requests and data transferred.

Learn more about how the [Router Cache](https://nextjs.org/docs/app/building-your-application/data-fetching/fetching-caching-and-revalidating#caching-data) works and how to configure it.

### [3. Partial(部分) Rendering](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#3-partial-rendering)

Partial rendering means only the route segments that change on navigation re-render on the client, and any shared segments are preserved(保留).

For example, when navigating between two sibling(兄弟) routes, `/dashboard/settings` and `/dashboard/analytics`, the `settings` and `analytics` pages will be rendered, and the shared `dashboard` layout will be preserved.

<img src="image/imageurl=%252Fdocs%252Flight%252Fpartial-rendering.png" alt="How partial rendering works" style="zoom:50%;" />

Without partial rendering, each navigation would cause the full page to re-render on the server. 

Rendering only the segment that changes reduces the amount of data transferred and execution time, leading to improved performance.

### [4. Soft Navigation](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#4-soft-navigation)

By default, the browser performs a hard navigation between pages. 

This means the browser reloads the page and resets React state such as `useState` hooks in your app and browser state such as the user's scroll position or focused element.

However, in Next.js, the App Router uses soft navigation.

This means React only renders the segments that have changed while preserving React and browser state, and there is no full page reload.

感觉像是keep-alive?

### [5. Back and Forward Navigation](https://nextjs.org/docs/app/building-your-application/routing/linking-and-navigating#5-back-and-forward-navigation)

By default, Next.js will maintain the scroll position for backwards and forwards navigation, and re-use route segments in the [Router Cache](https://nextjs.org/docs/app/building-your-application/data-fetching/fetching-caching-and-revalidating#caching-data).

# Route Groups

In the `app` directory, nested folders are normally mapped to URL paths. 

However, you can mark a folder as a **Route Group** to prevent the folder from being included in the route's URL path.

This allows you to organize your route segments and project files into logical groups without affecting the URL path structure.

Route groups are useful for:

- [Organizing routes into groups](https://nextjs.org/docs/app/building-your-application/routing/route-groups#organize-routes-without-affecting-the-url-path) e.g. by site section, intent(意图), or team.(将route按照站点部分、意图或团队进行分类整理。)
- Enabling [nested layouts](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts) in the same route segment level:(在同一路由段级别启用嵌套布局)
  - [Creating multiple nested layouts in the same segment, including multiple root layouts](https://nextjs.org/docs/app/building-your-application/routing/route-groups#creating-multiple-root-layouts)
  - [Adding a layout to a subset of routes in a common segment](https://nextjs.org/docs/app/building-your-application/routing/route-groups#opting-specific-segments-into-a-layout)(在一个路由中为一部分子路由添加布局。)

---

## [Convention](https://nextjs.org/docs/app/building-your-application/routing/route-groups#convention)(约定)

A route group can be created by wrapping a folder's name in parenthesis:`(folderName)`

---

## [Examples](https://nextjs.org/docs/app/building-your-application/routing/route-groups#examples)

### [Organize routes without affecting the URL path](https://nextjs.org/docs/app/building-your-application/routing/route-groups#organize-routes-without-affecting-the-url-path)

To organize routes without affecting the URL, create a group to keep related routes together. 

括号中的文件夹将从URL中省略（例如，(marketing)或(shop)）。

<img src="image/imageurl=%252Fdocs%252Flight%252Froute-group-organisation.png" alt="Organizing Routes with Route Groups" style="zoom:50%;" />

尽管（marketing）和（shop）内部的路由共享相同的URL层次结构，但您可以通过在它们的文件夹中添加layout.js文件为每个组创建不同的布局。

<img src="image/imageurl=%252Fdocs%252Flight%252Froute-group-multiple-layouts.png" alt="Route Groups with Multiple Layouts" style="zoom:50%;" />

### [Opting specific segments into a layout](https://nextjs.org/docs/app/building-your-application/routing/route-groups#opting-specific-segments-into-a-layout)

To opt specific routes into a layout, create a new route group (e.g. `(shop)`) and move the routes that share the same layout into the group (e.g. `account` and `cart`).

 The routes outside of the group will not share the layout (e.g. `checkout`).

<img src="image/imageurl=%252Fdocs%252Flight%252Froute-group-opt-in-layouts.png" alt="Route Groups with Opt-in Layouts" style="zoom:50%;" />

### [Creating multiple root layouts](https://nextjs.org/docs/app/building-your-application/routing/route-groups#creating-multiple-root-layouts)

To create multiple [root layouts](https://nextjs.org/docs/app/building-your-application/routing/pages-and-layouts#root-layout-required), remove the top-level `layout.js` file, and add a `layout.js` file inside each route groups. 

This is useful for partitioning(划分) an application into sections that have a completely different UI or experience. 

The `<html>` and `<body>` tags need to be added to each root layout.

<img src="image/imageurl=%252Fdocs%252Flight%252Froute-group-multiple-root-layouts.png" alt="Route Groups with Multiple Root Layouts" style="zoom:50%;" />

In the example above, both `(marketing)` and `(shop)` have their own root layout.

---

> **Good to know**:
>
> - The naming of route groups has no special significance other than for organization. They do not affect the URL path.
>
> - Routes that include a route group **should not** resolve to the same URL path as other routes.(就是说同一层次路由组下路由不能同名)
>
>   For example, since route groups don't affect URL structure, `(marketing)/about/page.js` and `(shop)/about/page.js` would both resolve to `/about` and cause an error.
>
> - If you use multiple root layouts without a top-level `layout.js` file, your home `page.js` file should be defined in one of the route groups, For example: `app/(marketing)/page.js`.
>
> - 跨越多个根布局进行导航将导致完全的页面重新加载（而不是进行客户端导航）。
>
>    For example, navigating from `/cart` that uses `app/(shop)/layout.js` to `/blog` that uses `app/(marketing)/layout.js` will cause a full page load. This **only** applies to multiple root layouts.

---

# Loading UI and Streaming

The special file `loading.js` helps you create meaningful Loading UI with [React Suspense](https://react.dev/reference/react/Suspense). 

